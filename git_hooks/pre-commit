#!/bin/bash

GIT_HOME=`git rev-parse --show-toplevel`
ESLINT="node_modules/.bin/eslint"

# Find modified files
DIFF_FILES=($(git diff --cached --name-only --diff-filter=ACM | grep ".js$"))
if [[ "$DIFF_FILES" = "" ]]; then
  # No js files to be checked.
  exit 0
fi

# Jump to git root dir
pushd ${GIT_HOME}

# ESLint existed?
if [[ ! -x "$ESLINT" ]];
then
  echo -e "\033[41;37mPlease install ESLint:\033[0m"
  echo "npm i --save-dev eslint eslint-config-airbnb-base eslint-plugin-import"
  exit 1
fi

# Run ESLint
$ESLINT "${DIFF_FILES[@]}"
ESLINT_EXIT="$?"

# Back to original dir
popd

# ESLint result
if [[ "${ESLINT_EXIT}" == 0 ]];
then
  echo -e "\033[31mCOMMIT SUCCEEDED\033[0m"
else
  echo -e "\033[41;37mCOMMIT NOT ALLOWED:\033[0m Please fix ESLint errors."
  exit 1
fi

exit $?
